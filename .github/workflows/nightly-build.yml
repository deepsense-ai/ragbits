name: Nightly Build

on:
  schedule:
    - cron: "0 2 * * *" # Daily at 2 AM UTC
  workflow_dispatch: # Manual trigger for testing
    inputs:
      dry-run:
        description: 'Dry run (skip publishing to PyPI and npm)'
        required: false
        type: boolean
        default: false

jobs:
  check-for-changes:
    runs-on: ubuntu-latest
    outputs:
      should-build: ${{ steps.check.outputs.should-build }}
      commit-hash: ${{ steps.check.outputs.commit-hash }}
      nightly-version: ${{ steps.check.outputs.nightly-version }}
    steps:
      - name: Checkout develop branch
        uses: actions/checkout@v4
        with:
          ref: develop
          fetch-depth: 0

      - name: Install uv
        uses: astral-sh/setup-uv@v2
        with:
          version: ${{ vars.UV_VERSION || '0.6.9' }}

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.10"

      - name: Check if nightly build needed
        if: ${{ inputs.dry-run != true }}
        id: check
        run: uv run scripts/check_nightly_build.py

  build:
    needs: check-for-changes
    if: inputs.dry-run == true || needs.check-for-changes.outputs.should-build == 'true'
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout develop branch
        uses: actions/checkout@v4
        with:
          ref: develop
          token: ${{ secrets.GH_TOKEN }}
          fetch-depth: 0

      - name: Install uv
        uses: astral-sh/setup-uv@v2
        with:
          version: ${{ vars.UV_VERSION || '0.6.9' }}

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.10"

      - name: Update package versions for nightly
        if: ${{ github.event_name == 'schedule' || inputs.dry-run != true }}
        run: |
          uv run scripts/update_nightly_versions.py "${{ needs.check-for-changes.outputs.nightly-version }}"
          uv run scripts/update_nightly_npm_versions.py "${{ needs.check-for-changes.outputs.nightly-version }}"

      - name: Install dependencies
        run: |
          uv sync --all-extras

      - name: Build packages
        run: |
          for dir in packages/*/; do
            echo "Building $dir"
            uv build "$dir" --out-dir dist
          done

      - name: Upload built packages
        uses: actions/upload-artifact@v4
        with:
          name: nightly-packages
          path: dist/**
          retention-days: 3

      - name: Sync versions to repo and push tag
        if: ${{ github.event_name == 'schedule' || inputs.dry-run != true }}
        run: |
          git config user.name "ds-ragbits-robot"
          git config user.email "ds-ragbits-robot@users.noreply.github.com"
          git add packages/*/pyproject.toml typescript/@ragbits/*/package.json

          if git diff --cached --quiet; then
            echo "No changes to commit"
          else
            git commit -m "chore: update package versions for nightly build ${{ env.NIGHTLY_VERSION }}"
            git push origin develop
          fi

          git tag "${{ env.NIGHTLY_VERSION }}"
          git push origin "${{ env.NIGHTLY_VERSION }}"
        env:
          GH_TOKEN: ${{ secrets.GH_TOKEN }}
          NIGHTLY_VERSION: ${{ needs.check-for-changes.outputs.nightly-version }}

  test-packages:
    name: Test packages
    needs: build
    uses: ./.github/workflows/shared-packages.yml
    with:
      artifact-name: nightly-packages
      skip-build: true
      skip-lints: true
      install-methods: '["package"]'

  publish:
    needs: [check-for-changes, test-packages]
    runs-on: ubuntu-latest
    permissions:
      contents: write
      id-token: write
    steps:
      - name: Checkout develop branch
        uses: actions/checkout@v4
        with:
          ref: develop
          token: ${{ secrets.GH_TOKEN }}
          fetch-depth: 0

      - name: Install uv
        uses: astral-sh/setup-uv@v2
        with:
          version: ${{ vars.UV_VERSION || '0.6.9' }}

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.10"

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "lts/*"
          registry-url: "https://registry.npmjs.org"

      - name: Download built packages
        uses: actions/download-artifact@v4
        with:
          name: nightly-packages
          path: dist

      - name: Dry run notice
        if: ${{ inputs.dry-run == true }}
        run: |
          echo "::notice::üîç DRY RUN MODE: Skipping all publishing steps (PyPI, npm, docs, git push)"

      - name: Publish to PyPI
        if: ${{ github.event_name == 'schedule' || inputs.dry-run != true }}
        run: |
          uv tool run twine upload dist/* --verbose
        env:
          TWINE_USERNAME: __token__
          TWINE_REPOSITORY_URL: ${{ vars.PYPI_URL || 'https://test.pypi.org/legacy/' }}
          TWINE_PASSWORD: ${{ secrets.PYPI_TOKEN }}

      - name: Install TypeScript dependencies
        if: ${{ github.event_name == 'schedule' || inputs.dry-run != true }}
        run: npm ci

      - name: Build npm packages
        if: ${{ github.event_name == 'schedule' || inputs.dry-run != true }}
        run: npm run build:packages

      - name: Publish @ragbits/api-client (dev)
        if: ${{ github.event_name == 'schedule' || inputs.dry-run != true }}
        run: npm publish --provenance --access public --tag dev
        working-directory: typescript/@ragbits/api-client
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

      - name: Publish @ragbits/api-client-react (dev)
        if: ${{ github.event_name == 'schedule' || inputs.dry-run != true }}
        run: npm publish --provenance --access public --tag dev
        working-directory: typescript/@ragbits/api-client-react
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

      - name: Deploy nightly documentation
        if: ${{ github.event_name == 'schedule' || inputs.dry-run != true }}
        shell: bash
        run: |
          git config user.name "ds-ragbits-robot"
          git config user.email "ds-ragbits-robot@users.noreply.github.com"
          git fetch origin gh-pages
          uv run mike deploy --push --alias-type copy nightly
        env:
          GH_TOKEN: ${{ secrets.GH_TOKEN }}

      - name: Notify on failure
        if: failure()
        run: |
          echo "Nightly build failed for commit ${{ needs.check-for-changes.outputs.commit-hash }}"
          echo "Version attempted: ${{ needs.check-for-changes.outputs.nightly-version }}"
