name: Nightly Build

on:
  schedule:
    - cron: "0 2 * * *" # Daily at 2 AM UTC
  workflow_dispatch: # Manual trigger for testing

jobs:
  check-for-changes:
    runs-on: ubuntu-latest
    outputs:
      should-build: ${{ steps.check.outputs.should-build }}
      commit-hash: ${{ steps.check.outputs.commit-hash }}
      nightly-version: ${{ steps.check.outputs.nightly-version }}
    steps:
      - name: Checkout develop branch
        uses: actions/checkout@v4
        with:
          ref: develop
          fetch-depth: 0

      - name: Install uv
        uses: astral-sh/setup-uv@v2
        with:
          version: ${{ vars.UV_VERSION || '0.6.9' }}

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.10"

      - name: Check if nightly build needed
        id: check
        run: uv run scripts/check_nightly_build.py

  build-test-and-publish:
    needs: check-for-changes
    if: needs.check-for-changes.outputs.should-build == 'true'
    runs-on: ubuntu-latest
    timeout-minutes: 30
    permissions:
      contents: write
      id-token: write

    services:
      postgres:
        image: pgvector/pgvector:0.8.0-pg17
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: tests
        ports:
          - 5432:5432
        options: >-
          --health-cmd "pg_isready -U postgres"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
      weaviate:
        image: cr.weaviate.io/semitechnologies/weaviate:1.30.6
        env:
          QUERY_DEFAULTS_LIMIT: 25
          AUTHENTICATION_ANONYMOUS_ACCESS_ENABLED: true
          PERSISTENCE_DATA_PATH: /var/lib/weaviate
          ENABLE_API_BASED_MODULES: true
          CLUSTER_HOSTNAME: node1
        ports:
          - 8080:8080
          - 50051:50051
        options: >-
          --health-cmd "wget --no-verbose --tries=1 --spider http://localhost:8080/v1/.well-known/ready || exit 1"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - name: Checkout develop branch
        uses: actions/checkout@v4
        with:
          ref: develop
          token: ${{ secrets.GH_TOKEN }}
          fetch-depth: 0

      - name: Install uv
        uses: astral-sh/setup-uv@v2
        with:
          version: ${{ vars.UV_VERSION || '0.6.9' }}

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.10"

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "lts/*"
          registry-url: "https://registry.npmjs.org"

      - name: Update package versions for nightly
        run: |
          uv run scripts/update_nightly_versions.py "${{ needs.check-for-changes.outputs.nightly-version }}"
          uv run scripts/update_nightly_npm_versions.py "${{ needs.check-for-changes.outputs.nightly-version }}"

      - name: Install dependencies
        run: |
          uv sync --all-extras

      - name: Build packages
        run: |
          for dir in packages/*/; do
            echo "Building $dir"
            uv build "$dir" --out-dir dist
          done

      - name: Test built packages
        uses: ./.github/actions/test-packages
        with:
          python-version: "3.10"
          google-drive-clientid-json: ${{ secrets.GOOGLE_DRIVE_CLIENTID_JSON }}
          google-source-unit-test-folder: ${{ secrets.GOOGLE_SOURCE_UNIT_TEST_FOLDER }}
          google-drive-target-email: ${{ secrets.GOOGLE_DRIVE_TARGET_EMAIL }}

      - name: Sync versions to repo and push tag
        run: |
          git config user.name "ds-ragbits-robot"
          git config user.email "ds-ragbits-robot@users.noreply.github.com"
          git add packages/*/pyproject.toml typescript/@ragbits/*/package.json

          if git diff --cached --quiet; then
            echo "No changes to commit"
          else
            git commit -m "chore: update package versions for nightly build ${{ env.NIGHTLY_VERSION }}"
            git push origin develop
          fi

          git tag "${{ env.NIGHTLY_VERSION }}"
          git push origin "${{ env.NIGHTLY_VERSION }}"
        env:
          GH_TOKEN: ${{ secrets.GH_TOKEN }}
          NIGHTLY_VERSION: ${{ needs.check-for-changes.outputs.nightly-version }}

      - name: Publish to PyPI
        run: |
          uv tool run twine upload dist/* --verbose
        env:
          TWINE_USERNAME: __token__
          TWINE_REPOSITORY_URL: ${{ vars.PYPI_URL || 'https://test.pypi.org/legacy/' }}
          TWINE_PASSWORD: ${{ secrets.PYPI_TOKEN }}

      - name: Install TypeScript dependencies
        run: npm ci

      - name: Build npm packages
        run: npm run build:packages

      - name: Publish @ragbits/api-client (dev)
        run: npm publish --provenance --access public --tag dev
        working-directory: typescript/@ragbits/api-client
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

      - name: Publish @ragbits/api-client-react (dev)
        run: npm publish --provenance --access public --tag dev
        working-directory: typescript/@ragbits/api-client-react
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

      - name: Deploy nightly documentation
        shell: bash
        run: |
          git config user.name "ds-ragbits-robot"
          git config user.email "ds-ragbits-robot@users.noreply.github.com"
          git fetch origin gh-pages
          uv run mike deploy --push --alias-type copy nightly
        env:
          GH_TOKEN: ${{ secrets.GH_TOKEN }}

      - name: Notify on failure
        if: failure()
        run: |
          echo "Nightly build failed for commit ${{ needs.check-for-changes.outputs.commit-hash }}"
          echo "Version attempted: ${{ needs.check-for-changes.outputs.nightly-version }}"
